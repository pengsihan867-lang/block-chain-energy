<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè≠ VPP Energy Trading System</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; color: #333; }
        .container { max-width: 1600px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; margin-bottom: 30px; color: white; }
        .header h1 { font-size: 3rem; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .card { background: white; border-radius: 20px; padding: 30px; margin-bottom: 30px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
        .card h2 { color: #2c3e50; margin-bottom: 25px; font-size: 1.8rem; border-bottom: 3px solid #3498db; padding-bottom: 15px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #555; }
        input, select { width: 100%; padding: 12px 15px; border: 2px solid #e1e8ed; border-radius: 10px; font-size: 16px; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }
        .btn { background: #3498db; color: white; padding: 15px 30px; border: none; border-radius: 10px; cursor: pointer; font-size: 16px; margin: 5px; }
        .btn:hover { background: #2980b9; }
        .btn-success { background: #27ae60; }
        .btn-warning { background: #f39c12; }
        .prosumer-form { background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 15px; padding: 20px; margin-bottom: 20px; }
        .prosumer-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #dee2e6; }
        .remove-prosumer { background: #e74c3c; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; }
        .result { margin-top: 25px; padding: 20px; border-radius: 15px; background: #e8f5e8; border-left: 5px solid #27ae60; }
        .chart-container { height: 300px; background: white; border-radius: 10px; padding: 20px; margin-top: 15px; overflow-x: auto; }
        .hourly-bar { display: inline-block; width: 20px; margin: 0 2px; background: #3498db; border-radius: 3px 3px 0 0; position: relative; }
        .trading-matrix { display: grid; gap: 10px; margin: 20px 0; }
        .trading-row { display: grid; grid-template-columns: 100px 1fr 1fr 1fr 1fr; gap: 10px; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 8px; }
        .trading-header { font-weight: bold; background: #e9ecef; }
        .vpp-status { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0; }
        .vpp-card { background: #f8f9fa; padding: 20px; border-radius: 15px; text-align: center; border: 2px solid #dee2e6; }
        .vpp-number { font-size: 2rem; font-weight: bold; color: #3498db; margin-bottom: 5px; }
        .transaction-item { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 8px; border-left: 4px solid #28a745; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè≠ VPP Energy Trading System</h1>
            <p>Advanced P2P Energy Trading with AI Prediction & Optimization</p>
        </div>

        <div class="main-content">
            <!-- Module 1: Prosumer Input Parameters -->
            <div class="card">
                <h2>üë• Prosumer Management</h2>
                <div id="prosumerContainer"></div>
                <button class="btn btn-success" onclick="addProsumer()">‚ûï Add Prosumer</button>
                <button class="btn btn-warning" onclick="generatePrediction()">üîÆ Generate Predictions</button>
            </div>

            <!-- Module 2: AI Prediction Results -->
            <div class="card" id="predictionCard" style="display: none;">
                <h2>üîÆ AI Generation Prediction Results</h2>
                <div id="predictionResults"></div>
            </div>

            <!-- Module 3: Trading Optimization -->
            <div class="card" id="optimizationCard" style="display: none;">
                <h2>‚öôÔ∏è Trading Optimization Results</h2>
                <div id="optimizationResults"></div>
            </div>

            <!-- Module 4: VPP Aggregation -->
            <div class="card" id="vppCard" style="display: none;">
                <h2>üè≠ VPP Aggregation & Battery Management</h2>
                <div id="vppResults"></div>
            </div>

            <!-- Module 5: Blockchain Integration -->
            <div class="card" id="blockchainCard" style="display: none;">
                <h2>‚õìÔ∏è Blockchain Transaction Status</h2>
                <div id="blockchainResults"></div>
            </div>
        </div>
    </div>

    <script>
        let prosumers = [];
        let predictions = {};
        let optimizationResults = {};
        let vppResults = {};
        let prosumerCounter = 0;

        document.addEventListener('DOMContentLoaded', function() {
            addProsumer();
        });

        function addProsumer() {
            prosumerCounter++;
            const prosumerId = `prosumer_${prosumerCounter}`;
            
            const prosumerForm = document.createElement('div');
            prosumerForm.className = 'prosumer-form';
            prosumerForm.id = prosumerId;
            
            prosumerForm.innerHTML = `
                <div class="prosumer-header">
                    <div style="font-size: 1.3rem; font-weight: bold; color: #2c3e50;">Prosumer ${prosumerCounter}</div>
                    <button class="remove-prosumer" onclick="removeProsumer('${prosumerId}')">√ó</button>
                </div>
                
                <div class="grid-3">
                    <div class="form-group">
                        <label for="${prosumerId}_name">User Name</label>
                        <input type="text" id="${prosumerId}_name" placeholder="Enter user name" required>
                    </div>
                    <div class="form-group">
                        <label for="${prosumerId}_area">PV Panel Area (m¬≤)</label>
                        <input type="number" id="${prosumerId}_area" placeholder="e.g., 20" step="0.1" required>
                    </div>
                    <div class="form-group">
                        <label for="${prosumerId}_efficiency">PV Efficiency (%)</label>
                        <input type="number" id="${prosumerId}_efficiency" placeholder="e.g., 18" min="0" max="100" step="0.1" required>
                    </div>
                </div>
                
                <div class="grid-3">
                    <div class="form-group">
                        <label for="${prosumerId}_orientation">Orientation</label>
                        <select id="${prosumerId}_orientation" required>
                            <option value="east">East</option>
                            <option value="southeast">Southeast</option>
                            <option value="south" selected>South</option>
                            <option value="southwest">Southwest</option>
                            <option value="west">West</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="${prosumerId}_hasBattery">Has Battery?</label>
                        <select id="${prosumerId}_hasBattery" onchange="toggleBattery('${prosumerId}')" required>
                            <option value="false">No</option>
                            <option value="true">Yes</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="${prosumerId}_role">User Role</label>
                        <select id="${prosumerId}_role" required>
                            <option value="prosumer" selected>Prosumer</option>
                            <option value="retailer">Retailer</option>
                        </select>
                    </div>
                </div>
                
                <div class="grid-3">
                    <div class="form-group">
                        <label for="${prosumerId}_batteryCapacity">Battery Capacity (kWh)</label>
                        <input type="number" id="${prosumerId}_batteryCapacity" placeholder="e.g., 5" step="0.1" disabled>
                    </div>
                    <div class="form-group">
                        <label for="${prosumerId}_maxBuy">Max Buy Limit (kWh)</label>
                        <input type="number" id="${prosumerId}_maxBuy" placeholder="e.g., 10" step="0.1" required>
                    </div>
                    <div class="form-group">
                        <label for="${prosumerId}_maxSell">Max Sell Limit (kWh)</label>
                        <input type="number" id="${prosumerId}_maxSell" placeholder="e.g., 15" step="0.1" required>
                    </div>
                </div>
                
                <div class="grid-2">
                    <div class="form-group">
                        <label for="${prosumerId}_price">Expected Price ($/kWh)</label>
                        <input type="number" id="${prosumerId}_price" placeholder="e.g., 0.12" step="0.01" required>
                    </div>
                </div>
            `;
            
            document.getElementById('prosumerContainer').appendChild(prosumerForm);
        }

        function removeProsumer(prosumerId) {
            document.getElementById(prosumerId).remove();
        }

        function toggleBattery(prosumerId) {
            const hasBattery = document.getElementById(`${prosumerId}_hasBattery`).value === 'true';
            const batteryInput = document.getElementById(`${prosumerId}_batteryCapacity`);
            batteryInput.disabled = !hasBattery;
            if (!hasBattery) batteryInput.value = '';
        }

        function generatePrediction() {
            const prosumerForms = document.querySelectorAll('.prosumer-form');
            if (prosumerForms.length === 0) {
                alert('Please add at least one prosumer first!');
                return;
            }

            prosumers = [];
            prosumerForms.forEach((form, index) => {
                const prosumerId = form.id;
                const prosumer = {
                    id: prosumerId,
                    name: document.getElementById(`${prosumerId}_name`).value || `Prosumer ${index + 1}`,
                    area: parseFloat(document.getElementById(`${prosumerId}_area`).value) || 20,
                    efficiency: parseFloat(document.getElementById(`${prosumerId}_efficiency`).value) || 18,
                    orientation: document.getElementById(`${prosumerId}_orientation`).value,
                    hasBattery: document.getElementById(`${prosumerId}_hasBattery`).value === 'true',
                    batteryCapacity: parseFloat(document.getElementById(`${prosumerId}_batteryCapacity`).value) || 0,
                    maxBuy: parseFloat(document.getElementById(`${prosumerId}_maxBuy`).value) || 10,
                    maxSell: parseFloat(document.getElementById(`${prosumerId}_maxSell`).value) || 15,
                    price: parseFloat(document.getElementById(`${prosumerId}_price`).value) || 0.12,
                    role: document.getElementById(`${prosumerId}_role`).value
                };
                prosumers.push(prosumer);
            });

            predictions = {};
            prosumers.forEach(prosumer => {
                predictions[prosumer.id] = generateHourlyPrediction(prosumer);
            });

            displayPredictions();
            document.getElementById('optimizationCard').style.display = 'block';
            alert('AI predictions generated successfully!');
        }

        function generateHourlyPrediction(prosumer) {
            const hourlyGeneration = [];
            const baseGeneration = (prosumer.area * prosumer.efficiency * 0.01) / 24;
            
            const orientationFactors = {
                'east': [0.8, 0.9, 1.0, 0.9, 0.8, 0.6, 0.4, 0.3, 0.2, 0.1, 0.1, 0.1, 0.1, 0.2, 0.3, 0.4, 0.6, 0.8, 0.9, 1.0, 0.9, 0.8, 0.6, 0.4],
                'southeast': [0.6, 0.7, 0.8, 0.9, 1.0, 0.9, 0.8, 0.7, 0.6, 0.5, 0.4, 0.3, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1.0, 0.9, 0.8, 0.6],
                'south': [0.1, 0.1, 0.2, 0.3, 0.4, 0.6, 0.8, 0.9, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 0.9, 0.8, 0.6, 0.4, 0.3, 0.2, 0.1],
                'southwest': [0.4, 0.6, 0.8, 0.9, 1.0, 0.9, 0.8, 0.7, 0.6, 0.5, 0.4, 0.3, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1.0, 0.9, 0.8, 0.6],
                'west': [0.2, 0.1, 0.1, 0.1, 0.1, 0.2, 0.3, 0.4, 0.6, 0.8, 0.9, 1.0, 0.9, 0.8, 0.6, 0.4, 0.3, 0.2, 0.1, 0.1, 0.1, 0.1, 0.2, 0.3]
            };
            
            const factors = orientationFactors[prosumer.orientation];
            
            for (let hour = 0; hour < 24; hour++) {
                let generation = baseGeneration * factors[hour];
                generation += (Math.random() - 0.5) * 0.2 * generation;
                generation = Math.max(0, generation);
                hourlyGeneration.push(parseFloat(generation.toFixed(2)));
            }
            
            return hourlyGeneration;
        }

        function displayPredictions() {
            const resultsDiv = document.getElementById('predictionResults');
            let html = '<div class="chart-container">';
            
            prosumers.forEach(prosumer => {
                html += `<h3>${prosumer.name} - 24h Generation Forecast</h3>`;
                html += '<div style="display: flex; align-items: end; height: 200px; gap: 2px;">';
                
                predictions[prosumer.id].forEach((value, hour) => {
                    const height = (value / Math.max(...predictions[prosumer.id])) * 150;
                    html += `<div class="hourly-bar" style="height: ${height}px;" title="${value} kWh"></div>`;
                });
                
                html += '</div>';
                html += '<div style="margin-top: 10px; text-align: center; color: #666;">Hour: 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23</div>';
                html += `<div style="margin-top: 10px; text-align: center;"><strong>Total Daily Generation: ${predictions[prosumer.id].reduce((a, b) => a + b, 0).toFixed(2)} kWh</strong></div>`;
            });
            
            html += '</div>';
            resultsDiv.innerHTML = html;
            document.getElementById('predictionCard').style.display = 'block';
            
            // Auto-trigger optimization
            setTimeout(() => {
                executeOptimization();
            }, 1000);
        }

        function executeOptimization() {
            if (Object.keys(predictions).length === 0) {
                alert('Please generate predictions first!');
                return;
            }

            optimizationResults = optimizeTrading();
            displayOptimization();
            
            setTimeout(() => {
                simulateVPP();
            }, 1000);
        }

        function optimizeTrading() {
            const results = { trades: [], totalCost: 0, totalRevenue: 0 };
            const buyers = prosumers.filter(p => p.role === 'prosumer' && p.maxBuy > 0);
            const sellers = prosumers.filter(p => p.role === 'prosumer' && p.maxSell > 0);

            buyers.forEach(buyer => {
                sellers.forEach(seller => {
                    if (buyer.id !== seller.id) {
                        const tradeAmount = Math.min(buyer.maxBuy, seller.maxSell, 5);
                        if (tradeAmount > 0) {
                            const price = (buyer.price + seller.price) / 2;
                            results.trades.push({
                                from: seller.id,
                                to: buyer.id,
                                amount: tradeAmount,
                                price: price,
                                cost: tradeAmount * price
                            });
                            results.totalCost += tradeAmount * price;
                            results.totalRevenue += tradeAmount * price;
                        }
                    }
                });
            });

            return results;
        }

        function displayOptimization() {
            const resultsDiv = document.getElementById('optimizationResults');
            
            let html = `
                <div class="trading-matrix">
                    <div class="trading-row trading-header">
                        <div>From</div>
                        <div>To</div>
                        <div>Amount (kWh)</div>
                        <div>Price ($/kWh)</div>
                        <div>Total ($)</div>
                    </div>
            `;
            
            optimizationResults.trades.forEach(trade => {
                const fromName = prosumers.find(p => p.id === trade.from)?.name || trade.from;
                const toName = prosumers.find(p => p.id === trade.to)?.name || trade.to;
                
                html += `
                    <div class="trading-row">
                        <div>${fromName}</div>
                        <div>${toName}</div>
                        <div>${trade.amount}</div>
                        <div>$${trade.price.toFixed(3)}</div>
                        <div>$${trade.cost.toFixed(2)}</div>
                    </div>
                `;
            });
            
            html += `
                </div>
                <div style="margin-top: 20px; padding: 20px; background: #e8f5e8; border-radius: 10px;">
                    <h4>Optimization Summary</h4>
                    <p><strong>Total Trades:</strong> ${optimizationResults.trades.length}</p>
                    <p><strong>Total Volume:</strong> ${optimizationResults.trades.reduce((sum, t) => sum + t.amount, 0).toFixed(2)} kWh</p>
                    <p><strong>Total Value:</strong> $${optimizationResults.totalCost.toFixed(2)}</p>
                </div>
            `;
            
            resultsDiv.innerHTML = html;
        }

        function simulateVPP() {
            vppResults = {
                batterySchedule: [],
                totalExternalBuy: 0,
                totalExternalSell: 0
            };

            const batteryCapacity = 5;
            let batteryLevel = 2.5;
            
            for (let hour = 0; hour < 24; hour++) {
                const netGeneration = prosumers.reduce((sum, p) => {
                    if (predictions[p.id]) {
                        return sum + predictions[p.id][hour];
                    }
                    return sum;
                }, 0);
                
                const netDemand = optimizationResults.trades.reduce((sum, t) => {
                    if (t.from === 'external') return sum + t.amount;
                    if (t.to === 'external') return sum - t.amount;
                    return sum;
                }, 0);
                
                const netEnergy = netGeneration - netDemand;
                
                let batteryAction = 'idle';
                let batteryChange = 0;
                
                if (netEnergy > 0 && batteryLevel < batteryCapacity) {
                    batteryAction = 'charge';
                    batteryChange = Math.min(netEnergy, batteryCapacity - batteryLevel);
                    batteryLevel += batteryChange * 0.9;
                } else if (netEnergy < 0 && batteryLevel > 0) {
                    batteryAction = 'discharge';
                    batteryChange = Math.min(-netEnergy, batteryLevel);
                    batteryLevel -= batteryChange / 0.9;
                }
                
                vppResults.batterySchedule.push({
                    hour: hour,
                    action: batteryAction,
                    change: batteryChange,
                    level: batteryLevel
                });
            }
            
            displayVPPResults();
            document.getElementById('blockchainCard').style.display = 'block';
        }

        function displayVPPResults() {
            const resultsDiv = document.getElementById('vppResults');
            
            let html = `
                <div class="vpp-status">
                    <div class="vpp-card">
                        <div class="vpp-number">${vppResults.batterySchedule.length}</div>
                        <div>Hours Simulated</div>
                    </div>
                    <div class="vpp-card">
                        <div class="vpp-number">${vppResults.batterySchedule.filter(s => s.action !== 'idle').length}</div>
                        <div>Battery Actions</div>
                    </div>
                    <div class="vpp-card">
                        <div class="vpp-number">5.0</div>
                        <div>Battery Capacity (kWh)</div>
                    </div>
                    <div class="vpp-card">
                        <div class="vpp-number">90%</div>
                        <div>Battery Efficiency</div>
                    </div>
                </div>
                
                <h4>Battery Schedule (24h)</h4>
                <div style="max-height: 200px; overflow-y: auto;">
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 10px; font-weight: bold;">
                        <div>Hour</div>
                        <div>Action</div>
                        <div>Change</div>
                        <div>Level</div>
                    </div>
            `;
            
            vppResults.batterySchedule.forEach(schedule => {
                html += `
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; padding: 5px; background: #f8f9fa; border-radius: 5px;">
                        <div>${schedule.hour}:00</div>
                        <div>${schedule.action}</div>
                        <div>${schedule.change.toFixed(2)}</div>
                        <div>${schedule.level.toFixed(2)}</div>
                    </div>
                `;
            });
            
            html += '</div>';
            resultsDiv.innerHTML = html;
            
            // Auto-trigger blockchain
            setTimeout(() => {
                submitToBlockchain();
            }, 1000);
        }

        function submitToBlockchain() {
            if (!optimizationResults.trades || optimizationResults.trades.length === 0) {
                alert('No trades to submit to blockchain!');
                return;
            }

            const transactions = [];
            optimizationResults.trades.forEach((trade, index) => {
                const transaction = {
                    hash: '0x' + Math.random().toString(16).substr(2, 64),
                    from: trade.from,
                    to: trade.to,
                    amount: trade.amount,
                    price: trade.price,
                    gasUsed: Math.floor(Math.random() * 100000) + 50000,
                    timestamp: new Date().toISOString(),
                    status: 'confirmed'
                };
                transactions.push(transaction);
            });
            
            displayBlockchainResults(transactions);
            alert('All trades submitted to blockchain successfully!');
        }

        function displayBlockchainResults(transactions) {
            const resultsDiv = document.getElementById('blockchainResults');
            
            let html = `
                <h4>Blockchain Transaction Status</h4>
                <p><strong>Total Transactions:</strong> ${transactions.length}</p>
                <p><strong>Status:</strong> <span style="color: #27ae60;">All confirmed</span></p>
                
                <h4>Transaction Details</h4>
            `;
            
            transactions.forEach((tx, index) => {
                const fromName = prosumers.find(p => p.id === tx.from)?.name || tx.from;
                const toName = prosumers.find(p => p.id === tx.to)?.name || tx.to;
                
                html += `
                    <div class="transaction-item">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                            <div><strong>Hash:</strong> ${tx.hash.substring(0, 10)}...</div>
                            <div><strong>From:</strong> ${fromName}</div>
                            <div><strong>To:</strong> ${toName}</div>
                            <div><strong>Amount:</strong> ${tx.amount} kWh</div>
                            <div><strong>Price:</strong> $${tx.price.toFixed(3)}</div>
                            <div><strong>Gas Used:</strong> ${tx.gasUsed}</div>
                            <div><strong>Status:</strong> <span style="color: #27ae60;">${tx.status}</span></div>
                            <div><strong>Time:</strong> ${new Date(tx.timestamp).toLocaleTimeString()}</div>
                        </div>
                    </div>
                `;
            });
            
            resultsDiv.innerHTML = html;
        }
    </script>
</body>
</html>
